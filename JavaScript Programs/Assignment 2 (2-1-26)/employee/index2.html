<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Management</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="container py-4">
      <h1 class="mb-4">Employee Management</h1>

      <div class="row">
        <!-- FORM -->
        <div class="col-md-5">
          <form id="empForm">
            <div class="mb-3">
              <label>ID</label>
              <input id="id" class="form-control" required />
            </div>

            <div class="mb-3">
              <label>Name</label>
              <input id="name" class="form-control" required />
            </div>

            <div class="mb-3">
              <label>Email</label>
              <input id="email" class="form-control" required />
            </div>

            <div class="mb-3">
              <label>Gender</label><br />
              <input type="radio" name="gender" value="Male" /> Male
              <input type="radio" name="gender" value="Female" /> Female
            </div>

            <button class="btn btn-primary">Save</button>
            <button id="clearBtn" type="button" class="btn btn-secondary ms-2">
              Clear
            </button>
          </form>
        </div>

        <!-- TABLE -->
        <div class="col-md-7">
          <div class="mb-2">
            <button id="editSelected" class="btn btn-sm btn-primary" disabled>
              Edit Selected
            </button>
            <button id="deleteSelected" class="btn btn-sm btn-danger" disabled>
              Delete Selected
            </button>
          </div>

          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll" /></th>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Gender</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const BASE_URL = "http://localhost:3000/api/employees";

      /* ---------- DOM ---------- */
      const dom = {
        form: document.getElementById("empForm"),
        tbody: document.getElementById("list"),
        id: document.getElementById("id"),
        name: document.getElementById("name"),
        email: document.getElementById("email"),
        genders: document.querySelectorAll("input[name='gender']"),
        clearBtn: document.getElementById("clearBtn"),
        editBtn: document.getElementById("editSelected"),
        deleteBtn: document.getElementById("deleteSelected"),
        selectAll: document.getElementById("selectAll"),
      };

      /* ---------- HELPERS ---------- */
      function getFormData() {
        return {
          id: dom.id.value.trim(),
          name: dom.name.value.trim(),
          email: dom.email.value.trim(),
          gender: [...dom.genders].find((g) => g.checked)?.value || "",
        };
      }

      function updateButtons() {
        const checked = dom.tbody.querySelectorAll(".rowCheck:checked");
        dom.editBtn.disabled = checked.length !== 1;
        dom.deleteBtn.disabled = checked.length === 0;
      }

      /* ---------- FETCH ---------- */
      async function fetchEmployees() {
        const res = await fetch(BASE_URL);
        const data = await res.json();

        dom.tbody.innerHTML = "";

        data.forEach((emp) => {
          dom.tbody.innerHTML += `
      <tr>
        <td><input type="checkbox" class="rowCheck" data-id="${emp.id}"></td>
        <td>${emp.id}</td>
        <td>${emp.name}</td>
        <td>${emp.email}</td>
        <td>${emp.gender}</td>
        <td></td>
      </tr>
    `;
        });

        updateButtons();
      }

      /* ---------- FORM ---------- */
      dom.form.addEventListener("submit", async (e) => {
        e.preventDefault();

        await fetch(BASE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(getFormData()),
        });

        dom.form.reset();
        fetchEmployees();
      });

      dom.clearBtn.onclick = () => dom.form.reset();

      /* ---------- SELECT ---------- */
      dom.tbody.onchange = updateButtons;

      dom.selectAll.onchange = () => {
        dom.tbody
          .querySelectorAll(".rowCheck")
          .forEach((cb) => (cb.checked = dom.selectAll.checked));
        updateButtons();
      };

      /* ---------- INLINE EDIT ---------- */
      dom.editBtn.onclick = () => {
        const row = dom.tbody.querySelector(".rowCheck:checked")?.closest("tr");
        if (!row) return;

        const id = row.children[1].innerText;
        const name = row.children[2].innerText;
        const email = row.children[3].innerText;
        const gender = row.children[4].innerText;

        row.innerHTML = `
    <td></td>
    <td>${id}</td>
    <td><input class="form-control form-control-sm" value="${name}"></td>
    <td><input class="form-control form-control-sm" value="${email}"></td>
    <td>
      <select class="form-select form-select-sm">
        <option ${gender === "Male" ? "selected" : ""}>Male</option>
        <option ${gender === "Female" ? "selected" : ""}>Female</option>
      </select>
    </td>
    <td>
      <button class="btn btn-sm btn-success saveRow">Save</button>
      <button class="btn btn-sm btn-secondary cancelRow">Cancel</button>
    </td>
  `;
      };

      /* ---------- SAVE / CANCEL ---------- */
      dom.tbody.addEventListener("click", async (e) => {
        const row = e.target.closest("tr");

        if (e.target.classList.contains("saveRow")) {
          const id = row.children[1].innerText;
          const name = row.children[2].querySelector("input").value;
          const email = row.children[3].querySelector("input").value;
          const gender = row.children[4].querySelector("select").value;

          await fetch(`${BASE_URL}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, gender }),
          });

          fetchEmployees();
        }

        if (e.target.classList.contains("cancelRow")) {
          fetchEmployees();
        }
      });

      /* ---------- BULK DELETE ---------- */
      dom.deleteBtn.onclick = async () => {
        const selected = [...dom.tbody.querySelectorAll(".rowCheck:checked")];
        if (!confirm(`Delete ${selected.length} employee(s)?`)) return;

        const ids = selected.map((cb) => cb.dataset.id);

        await fetch(`${BASE_URL}/bulk-delete`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids }),
        });

        fetchEmployees();
      };

      /* ---------- INIT ---------- */
      fetchEmployees();
    </script>
  </body>
</html>

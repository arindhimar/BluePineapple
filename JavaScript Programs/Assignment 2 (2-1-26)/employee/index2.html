<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="container py-4">
      <h1 class="mb-4">Employee Management</h1>

      <div id="msg"></div>

      <div class="row">
        <div class="col-md-5">
          <form id="empForm">
            <div class="mb-3">
              <label class="form-label">ID</label>
              <input id="id" class="form-control" />
            </div>
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input id="name" class="form-control" />
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input id="email" class="form-control" />
            </div>
            <div class="mb-3">
              <label class="form-label"> Gender </label><br />
              <div class="form-check form-check-inline">
                <input
                  class="form-check -input"
                  type="radio"
                  name="gender"
                  value="Male"
                />
                <label class="form-check-label">Male</label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check -input"
                  type="radio"
                  name="gender"
                  value="Female"
                />
                <label class="form-check-label">Female</label>
              </div>
            </div>
            <button class="btn btn-primary" type="submit">Save</button>
            <button id="clearBtn" type="button" class="btn btn-secondary ms-2">
              Clear
            </button>
          </form>
        </div>
        <div class="col-md-7">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Gender</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const baseURl = "http://localhost:3000/api/employees";

      let tempEditIt = null;

      const empForm = document.getElementById("empForm");
      const msgDiv = document.getElementById("msg");
      const listTbody = document.getElementById("list");
      const clearBtn = document.getElementById("clearBtn");
      const idInput = document.getElementById("id");
      const nameInput = document.getElementById("name");
      const emailInput = document.getElementById("email");
      const genderInputs = document.getElementsByName("gender");

      async function fetchEmployees() {
        try {
          const data = await fetch(baseURl);
          const employees = await data.json();

          for (let tempEmp in employees) {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${employees[tempEmp].id}</td>
                <td>${employees[tempEmp].name}</td>
                <td>${employees[tempEmp].email}</td>
                <td>${employees[tempEmp].gender}</td>
                <td>
                  <button class="btn btn-sm btn-primary editBtn" data-id="${employees[tempEmp].id}">Edit</button>
                  <button class="btn btn-sm btn-danger deleteBtn" data-id="${employees[tempEmp].id}">Delete</button>
                </td>
            `;
            listTbody.appendChild(tr);
          }
        } catch (error) {
          alert(error.message);
        }
      }

      async function addEmployee(empData) {
        try {
          const response = await fetch(baseURl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },

            body: JSON.stringify(empData),
          });
          if (!response.ok) {
            throw new Error("Failed to add employee");
          }

          alert("Employee added successfully");
          listTbody.innerHTML = "";
          fetchEmployees();
        } catch (error) {
          alert(error.message);
        }
      }

      async function updateEmployee(empId, empData) {
        try {
          const response = await fetch(`${baseURl}/${empId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(empData),
          });
          if (!response.ok) {
            throw new Error("Failed to update employee");
          }

          alert("Employee updated successfully");
          listTbody.innerHTML = "";
          fetchEmployees();
        } catch (error) {
          alert(error.message);
        }
      }

      empForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();

        const empId = idInput.value.trim();
        const empName = nameInput.value.trim();
        const empEmail = emailInput.value.trim();
        let empGender = "";
        for (let tempGender in genderInputs) {
          if (genderInputs[tempGender].checked) {
            empGender = genderInputs[tempGender].value;
            break;
          }
        }

        const empData = {
          id: empId,
          name: empName,
          email: empEmail,
          gender: empGender,
        };

        if (tempEditIt) {
          await updateEmployee(tempEditIt, empData);
          tempEditIt = null;
        } else {
          await addEmployee(empData);
        }
        empForm.reset();
      });

      clearBtn.addEventListener("click", () => {
        empForm.reset();
        tempEditIt = null;
      });

      listTbody.addEventListener("click", async (ev) => {
        if (ev.target.classList.contains("editBtn")) {
          const empId = ev.target.getAttribute("data-id");
          try {
            const response = await fetch(`${baseURl}/${empId}`);
            if (!response.ok) {
              throw new Error("Failed to fetch employee data");
            }
            const empData = await response.json();
            idInput.value = empData.id;
            nameInput.value = empData.name;
            emailInput.value = empData.email;
            for (let tempGender in genderInputs) {
              if (genderInputs[tempGender].value === empData.gender) {
                genderInputs[tempGender].checked = true;
              } else {
                genderInputs[tempGender].checked = false;
              }
            }
            tempEditIt = empId;
          } catch (error) {
            alert(error.message);
          }
        } 
        else if (ev.target.classList.contains("deleteBtn")) {
          const empId = ev.target.getAttribute("data-id");
          if (
            confirm("Are you sure you want to delete employee " + empId + "?")
          ) {
            try {
              const response = await fetch(`${baseURl}/${empId}`, {
                method: "DELETE",
              });
              if (!response.ok) {
                throw new Error("Failed to delete employee");
              }
              alert("Employee deleted successfully");
              listTbody.innerHTML = "";
              fetchEmployees();
            } catch (error) {
              alert(error.message);
            }
          }
        }
      });

      //fetch the initial employee list
      fetchEmployees();
    </script>
  </body>
</html>
